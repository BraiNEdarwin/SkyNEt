import numpy as np
from scipy import signal
from SkyNEt.config.config_class import config_class
import os

class experiment_config(config_class):
    '''
    This is the config for the wave search experiment. The input waves are generated by generateSineWave
    which can be configured with the parameters below. The input data is not saved in the experiment file
    (and also not in the RAM) since this takes up too much space. 
    '''

    def __init__(self):
        super().__init__() 

        self.waveElectrodes = 7
        self.factor = 0.05
        self.freq2 = np.array([2,np.pi,5,7,13,17,19]) 
        self.freq = np.sqrt(self.freq2[:self.waveElectrodes])*self.factor
        self.phase = np.zeros(self.waveElectrodes)
        self.sampleTime = 500 # Sample time of the sine waves for one grid point (in seconds)
        self.fs = 50
        self.transientTest = False
        self.n = 500 # Amount of test points for the transient test
        self.samplePoints = int(50*self.fs) # Amount of sample points per batch measurement (sampleTime*fs/samplePoints batches)
        self.amplification = 100
        self.gain_info = '10MV/A'
        self.postgain = 1
        self.amplitude = np.array([0.9, 0.9, 0.9, 0.9, 0.9, 0.5, 0.5]) # Maximum amount of voltage for the inputs
        self.offset = np.array([-0.3,-0.3,-0.3,-0.3,-0.3,-0.2,-0.2]) # Optional offset for the sine waves

        #                               Summing module S2d      Matrix module           device
        self.electrodeSetup = [['ao5','ao3','ao1','ao0','a02','ao4','ao6','out'],[1,3,5,6,11,13,15,17],[5,6,7,8,1,2,3,4]]

        # Save settings
        self.filepath = r'filepath'        
        self.name = 'name'
        self.configSrc = os.path.dirname(os.path.abspath(__file__))        
        self.inputData = self.generateTriangle



    def generateSineWave(self, freq, t, amplitude, fs, phase = np.zeros(7)):
        '''
        Generates a sine wave that can be used for the input data.
        freq:       Frequencies of the inputs in an one-dimensional array
        t:          The datapoint(s) index where to generate a sine value (1D array when multiple datapoints are used)
        amplitude:  Amplitude of the sine wave (Vmax in this case)
        fs:         Sample frequency of the device
        phase:      (Optional) phase offset at t=0
        '''

        return np.sin((2 * np.pi * freq[:, np.newaxis] * t)/ fs + phase[:,np.newaxis]) * amplitude[:,np.newaxis]



    def generateTriangle(self, freq, t, amplitude, fs, phase = np.zeros(7)):
        '''
        Generates a triangle wave form that can be used for the input data.
        freq:       Frequencies of the inputs in an one-dimensional array
        t:          The datapoint(s) index where to generate a sine value (1D array when multiple datapoints are used)
        amplitude:  Amplitude of the sine wave (Vmax in this case)
        fs:         Sample frequency of the device
        phase:      (Optional) phase offset at t=0
        ''' 
        # There is an additional + np.pi/2 to make sure that if phase = 0. the inputs start at 0V

        return signal.sawtooth((2* np.pi * freq[:,np.newaxis] * t)/fs + phase[:,np.newaxis] + np.pi/2, 0.5) * amplitude[:,np.newaxis]